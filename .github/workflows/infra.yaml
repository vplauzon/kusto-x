name:  Infrastructure Deployment

on:
  workflow_dispatch

jobs:
  arm:
    runs-on: ubuntu-latest
    
    env:
      # See OS catalog here:  https://docs.microsoft.com/en-us/dotnet/core/rid-catalog
      dotnetOs:  linux-x64

    steps:
    - uses: actions/checkout@v2
    - name: Azure Login
      run: az login --service-principal -u ${{ secrets.DEPLOY_CLIENT_ID }} -p ${{ secrets.DEPLOY_SECRET }} --tenant ${{ secrets.TENANT_ID }}
    - name: Azure Subscription Set
      run: az account set --name ${{ secrets.SUBSCRIPTION }}
    - name: Determine current environment
      run: |
        echo "Branch name:  ${{ github.ref_name }}"
        if [ ${{ github.ref_name }} == "main" ]
        then
          env="dev"
        elif [ ${{ github.ref_name }} == "staging" ]
        then
          env="stg"
        elif [ ${{ github.ref_name }} == "prod" ]
        then
          env="prd"
        else
          echo "The branch doesn't match an environment pattern"
          exit 1
        fi

        echo "Environment:  $env"
        echo "env=$env" >> $GITHUB_ENV

    - name: Deploy
      run: |
        cd deployment/infra
        bash deploy-infra.sh ${{ secrets.RESOURCE_GROUP }} $env
